<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUI Dogfood Production</title>

    <script type="module" src="https://web.cardholder-ui-sdk.marqeta.com/_/releases/0.10/index.js"></script>
    <script>
      // Function to extract URL parameters
      function getUrlParameter(name) {
          const regex = new RegExp(`[?&]${name}=([^&#]*)`);
          const results = regex.exec(window.location.search);
          return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      window.addEventListener("load", async () => {
          const applicationToken = getUrlParameter('applicationToken');
          const accessToken = getUrlParameter('accessToken');
          const userToken = getUrlParameter('userToken');
          const cardToken = getUrlParameter('cardToken');

          if (!applicationToken || !accessToken || !userToken) {
              console.error('Missing required URL parameters.');
              return;
          }

          // Base64 encode the credentials
          const credentials = `${applicationToken}:${accessToken}`;
          const base64Credentials = btoa(credentials);

          // Perform login
          let cuiAuthToken;
          try {
              const response = await fetch('https://cui-service-main.prod.us-east-1.mq01-prod.marqeta.io/api/v1/auth/login', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Basic ${base64Credentials}`
                  },
                  body: JSON.stringify({ 'user_token': userToken })
              });

              if (!response.ok) {
                  throw new Error('Login failed');
              }

              const data = await response.json();
              cuiAuthToken = data.token;

          } catch (error) {
              console.error('Error during login:', error);
              return;
          }

          // Initialize the Marqeta SDK
          window.marqeta.bootstrap({
              cuiAuthToken: cuiAuthToken,
              // themeName: 'optional-your-theme-name',
          });

          document.querySelector('mq-account')
              .addEventListener('mqAccountLoadSuccess', async () => {
                  const msg = 'Yay!! Your mq-account data has loaded successfully!';
                  publishEvent(msg);
              });

          // Replace card-token attributes with the cardToken from URL
          document.querySelectorAll('[card-token]').forEach(el => {
              el.setAttribute('card-token', cardToken);
          });
      });

      // Function to publish events to the right container
      const publishEvent = (event) => {
          const eventsList = document.getElementById('eventsList');
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.textContent = event;
          eventsList.appendChild(eventDiv);
      };
    </script>

    <style>
      * {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          margin: 0;
          padding: 0;
      }
      body {
          display: flex;
          height: 100vh;
      }
      .left-container {
          flex: 1;
          padding: 20px;
          background-color: #f0f0f0;
          overflow-y: auto;
      }
      .right-container {
          flex: 1;
          padding: 20px;
          background-color: #ffffff;
          overflow-y: auto;
          border-left: 1px solid #ccc;
      }
      div {
          margin-bottom: 20px;
          outline: 1px solid black;
          padding: 10px;
          border-radius: 5px;
      }
      #custom_log {
          margin-bottom: 20px;
      }
    </style>
</head>
<body>

    <div class="left-container">
        <h1>CUI Dogfood Production</h1>
        <div id="custom_log"></div>

        <div>
            <mq-account></mq-account>
        </div>

        <div>
            <mq-activate-card
                class="accepts-card-token"
                show-title={true}
                show-description={true}
                card-token="{cardToken}"
            ></mq-activate-card>
        </div>

        <div>
            <mq-reveal-pin
                class="accepts-card-token"
                show-title={true}
                card-token="{cardToken}"
                cardholder-verification-method="OTHER"
                timeout={10}
            ></mq-reveal-pin>
        </div>

        <div>
            <mq-set-pin
                class="accepts-card-token"
                show-title={true}
                show-description={true}
                card-token="{cardToken}"
            ></mq-set-pin>
        </div>

        <div>
            <mq-view-card-details
                class="accepts-card-token"
                card-token="{cardToken}"
            ></mq-view-card-details>
        </div>

        <div>
            <mq-transaction-activity></mq-transaction-activity>
        </div>
        
        <div>
            <mq-manage-linked-accounts></mq-manage-linked-accounts>
        </div>

        <div>
            <mq-add-linked-account></mq-add-linked-account>
        </div>
        
        <div>
            <mq-add-funds
                class="accepts-card-token"
            ></mq-add-funds>
        </div>
    </div>

    <div class="right-container" id="eventsContainer">
        <h2>Events</h2>
        <div id="eventsList">
            <!-- Events from components will be displayed here -->
        </div>
    </div>

    <script>
        // Listening to relevant events from components
  // List of common window events
const events = [
    'load',
    'resize',
    'scroll',
    'focus',
    'blur',
    'error',
    'beforeunload',
    'unload',
    'visibilitychange',
    'online',
    'offline',
];

// Function to handle and log events
function logEvent(event) {
    publishEvent(JSON.stringify(event));
}

// Attach event listeners for each event
events.forEach(eventType => {
    window.addEventListener(eventType, logEvent);
});

// Optional: Log all events, including custom ones
window.addEventListener('customEvent', logEvent);

        // document.querySelector('mq-reveal-pin').addEventListener('mqRevealPinSuccess', () => {
        //     publishEvent("PIN revealed successfully.");
        // });

        // document.querySelector('mq-set-pin').addEventListener('mqSetPinSuccess', () => {
        //     publishEvent("PIN set successfully.");
        // });

        // document.querySelector('mq-view-card-details').addEventListener('mqViewCardDetailsSuccess', () => {
        //     publishEvent("Card details viewed.");
        // });

        // Add more event listeners as necessary for other components
    </script>

</body>
</html>
