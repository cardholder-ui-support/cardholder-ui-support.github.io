<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUI Dogfood Production</title>

    <script type="module" src="https://web.cardholder-ui-sdk.marqeta.com/_/releases/0.10/index.js"></script>
    <script>
      // Function to extract URL parameters
      function getUrlParameter(name) {
        const regex = new RegExp(`[?&]${name}=([^&#]*)`);
        const results = regex.exec(window.location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      window.addEventListener("load", async () => {
        const applicationToken = getUrlParameter('applicationToken');
        const accessToken = getUrlParameter('accessToken');
        const userToken = getUrlParameter('userToken');
        const cardToken = getUrlParameter('cardToken'); // Extract cardToken

        if (!applicationToken || !accessToken || !userToken) {
          console.error('Missing required URL parameters.');
          return;
        }

        // Base64 encode the credentials
        const credentials = `${applicationToken}:${accessToken}`;
        const base64Credentials = btoa(credentials);

        // Perform login
        let cuiAuthToken;
        try {
          const response = await fetch('https://cui-service-main.prod.us-east-1.mq01-prod.marqeta.io/api/v1/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Basic ${base64Credentials}`
            },
            body: JSON.stringify({ 'user_token': userToken })
          });

          if (!response.ok) {
            throw new Error('Login failed');
          }

          const data = await response.json();
          cuiAuthToken = data.token;

        } catch (error) {
          console.error('Error during login:', error);
          return;
        }

        // Initialize the Marqeta SDK
        window.marqeta.bootstrap({
          cuiAuthToken: cuiAuthToken,
          // themeName: 'optional-your-theme-name',
        });

        document.querySelector('mq-account')
          .addEventListener('mqAccountLoadSuccess', async () => {
            const msg = 'Yay!! Your mq-account data has loaded successfully!';
            const customLog = document.getElementById('custom_log');
            customLog.innerHTML += `<p>${msg}</p>`;
          });

        // Replace card-token attributes with the cardToken from URL
        document.querySelectorAll('[card-token]').forEach(el => {
          el.setAttribute('card-token', cardToken);
        });
      });
    </script>

    <style>
      * {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      div {
        width: 600px;
        padding-bottom: 20px;
      }
    </style>
  </head>
  <body>

    <h1>CUI Dogfood Production</h1>

    <div id="custom_log"></div>

    <div>
      <mq-account></mq-account>
    </div>

    <div>
      <mq-activate-card
        class="accepts-card-token"
        show-title={true}
        show-description={true}
        card-token="{cardToken}"
      ></mq-activate-card>
    </div>

    <div>
      <mq-reveal-pin
        class="accepts-card-token"
        show-title={true}
        card-token="{cardToken}"
        cardholder-verification-method="OTHER"
        timeout={10}
      ></mq-reveal-pin>
    </div>

    <div>
      <mq-set-pin
        class="accepts-card-token"
        show-title={true}
        show-description={true}
        card-token="{cardToken}"
      ></mq-set-pin>
    </div>

    <div>
      <mq-view-card-details
        class="accepts-card-token"
        card-token="{cardToken}"
      ></mq-view-card-details>
    </div>

    <div>
      <mq-transaction-activity></mq-transaction-activity>
    </div>
    
    <div>
      <mq-manage-linked-accounts></mq-manage-linked-accounts>
    </div>

    <div>
      <mq-add-linked-account></mq-add-linked-account>
    </div>
    
    <div>
      <mq-add-funds
        class="accepts-card-token"
      ></mq-add-funds>
    </div>

    
  </body>
</html>
