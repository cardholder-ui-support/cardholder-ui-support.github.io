/**
 * Cardholder UI Web Components v0.22.0
 * (c) 2024 Marqeta
 * @license MIT
 */
import{r as t,k as i,i as s,F as o,H as n,j as e}from"./p-18a64bdb.js";import{c as r,P as l,Q as a,R as c,S as h,T as d,U as u,V as v,W as f}from"./p-675e89df.js";import{o as m,m as p}from"./p-c7bc8265.js";import{g as y}from"./p-324125bc.js";import{B as b}from"./p-3b5975cd.js";import{C as g,H as w}from"./p-cb5bbf71.js";import{F as q,a as k,b as x,c as T}from"./p-8b467760.js";import"./p-0462f723.js";import"./p-bc4f08b6.js";import"./p-52af63d3.js";const j=(t,i)=>{if(t===i){return true}if(typeof t!=="object"||t===null||typeof i!=="object"||i===null){return false}const s=Object.keys(t);const o=Object.keys(i);if(s.length!==o.length){return false}for(let n of s){if(!o.includes(n)||!j(t[n],i[n])){return false}}return true};const R="An error occurred while attempting to move to the next step. Try again.";const O="An error occurred while uploading your file. Try again.";const S="An error occurred while processing your request. Try again later.";const F="System error";const C="An error occurred while retrieving your document(s). Try uploading them again.";const E=":host{display:block;padding:var(--components-universal-padding);border:var(--components-universal-borderWidth) solid var(--components-universal-borderColor);background-color:var(--components-universal-backgroundColor);border-radius:var(--components-universal-borderRadius)}.file-dispute-form{background-color:var(--styles-background-surfacePrimaryColor);border-radius:var(--borderRadius-radius0)}.file-dispute-form.end{padding:0}.success-container{display:flex;flex-direction:column;row-gap:var(--spacing-spacing400);align-items:center;text-align:center}.success-container.xs{align-items:stretch}.review-container{flex-direction:column;row-gap:var(--spacing-spacing800)}mq-dynamic-form.hidden{display:none}.success-loading-skeleton-bones{width:100%;display:flex;flex-direction:column;gap:var(--spacing-spacing200)}.success-loading-skeleton-bones mq-bone:first-child{align-self:center}";const A=E;const D=class{constructor(n){t(this,n);this.mqFileDisputeLoadInitiated=i(this,"mqFileDisputeLoadInitiated",7);this.mqFileDisputeLoadCompleted=i(this,"mqFileDisputeLoadCompleted",7);this.mqFileDisputeActionTriggered=i(this,"mqFileDisputeActionTriggered",7);this.mqFileDisputeActionCompleted=i(this,"mqFileDisputeActionCompleted",7);this.mqFileDisputeActionHook=i(this,"mqFileDisputeActionHook",7);this.loadFileDisputeForm=async()=>{this.startLoadingAndClearError(q.form);try{const t=r.get(l);const i=await t.execute(this.transactionToken);const s=await this.checkAndFetchDocs(i);this.questionnaireData=s;setTimeout((()=>{this.mqFileDisputeLoadCompleted.emit({status:g.SUCCESS})}),0)}catch(t){this.handleDisputesErrors(t,S);setTimeout((()=>{this.mqFileDisputeLoadCompleted.emit({status:g.ERROR,error:{code:"DISPUTE_LOAD_ERROR"}})}),0)}this.hideLoader()};this.hideLoader=()=>{this.showLoaderType=q.none;this.loadingButton=k.none};this.startLoadingAndClearError=t=>{this.showLoaderType=t;this.error={message:"",description:""}};this.handleDisputesErrors=(t,i)=>{var s,o,n,e,r,l,a,c,h,d;const u=t;const v=(s=u===null||u===void 0?void 0:u.originalError)===null||s===void 0?void 0:s.message;console.error(u.message,v);const f=(n=(o=u===null||u===void 0?void 0:u.originalError)===null||o===void 0?void 0:o.debug)===null||n===void 0?void 0:n[0];const m=(e=f===null||f===void 0?void 0:f.data)===null||e===void 0?void 0:e.error_type;if(m==="DISPUTE_ERROR"){this.viewType=x.error}else if(m==="STEP_ERROR"&&((l=(r=f===null||f===void 0?void 0:f.data)===null||r===void 0?void 0:r.error_details)===null||l===void 0?void 0:l.question_errors)){const t=(c=(a=f===null||f===void 0?void 0:f.data)===null||a===void 0?void 0:a.error_details)===null||c===void 0?void 0:c.question_errors;const i=t.reduce(((t,i)=>{var s,o;t[i.question_id]=(o=(s=i.validation_errors)===null||s===void 0?void 0:s.map((t=>t.error_message)))!==null&&o!==void 0?o:i.error_message?[i.error_message]:[];return t}),{});this.formRef.setErrors(i);return}const p=(h=f===null||f===void 0?void 0:f.data)===null||h===void 0?void 0:h.error_message;let y=(d=f===null||f===void 0?void 0:f.data)===null||d===void 0?void 0:d.description;if(!y){y=p!==null&&p!==void 0?p:i}this.error={message:p!==null&&p!==void 0?p:F,description:y}};this.addAnsweredStep=t=>{const i=Number(t);const s=Array.from(this.stepsAnswered);s.forEach((t=>{if(t>i){this.stepsAnswered.delete(t)}}));this.stepsAnswered.add(i)};this.answerQuestionnaire=async t=>{this.startLoadingAndClearError(q.form);try{const i=r.get(a);const s=await i.execute(this.questionnaireData.disputeId,`${this.questionnaireData.stepId}`,t);if(s===null||s===void 0?void 0:s.schema){this.addAnsweredStep(this.questionnaireData.stepId);const t=await this.checkAndFetchDocs(s);this.questionnaireData=t}else{const{completed:t,disputeId:i}=s;if(t==="success"){await this.getReviewData(i)}}}catch(t){this.handleDisputesErrors(t,R)}this.hideLoader()};this.getReviewData=async t=>{this.startLoadingAndClearError(q.form);try{const i=r.get(c);const s=await i.execute(t);this.viewType=x.review;const o=s.documentQuestions.some((t=>s.answersForReview.some((i=>i.questionId===t&&i.answers.length))));const n=o?await this.retrieveDocsForDispute(t,false):{};const e=s.answersForReview.map((t=>{const i=Object.assign({},t);const o=i.questionId;const e=i.answers;const r=e.length;if(s.documentQuestions.includes(o)){const t=[];e.forEach((i=>{const s=n[i];if(s)t.push(s.name)}));if(t.length)i.answers=t;else i.answers=r?[`${r} file${r?"s":""} attached`]:[]}return i}));this.reviewData=Object.assign(Object.assign({},s),{answersForReview:e})}catch(t){this.handleDisputesErrors(t,S)}this.hideLoader()};this.getStepData=async(t,i)=>{this.startLoadingAndClearError(q.form);try{const s=r.get(h);const o=await s.execute(t,`${i}`);if(o===null||o===void 0?void 0:o.schema){const t=await this.checkAndFetchDocs(o);this.questionnaireData=t}if(this.viewType!==x.questionnaire)this.viewType=x.questionnaire}catch(t){this.handleDisputesErrors(t,S)}this.hideLoader()};this.checkAndFetchDocs=async t=>{var i,s,o,n,e;const r=Object.assign({},t);const l=r===null||r===void 0?void 0:r.disputeId;if(!l)return r;const a=[];for(const t in((i=r===null||r===void 0?void 0:r.uiSchema)===null||i===void 0?void 0:i["ui:fields"])||[]){if(((n=(o=(s=r===null||r===void 0?void 0:r.uiSchema)===null||s===void 0?void 0:s["ui:fields"])===null||o===void 0?void 0:o[t])===null||n===void 0?void 0:n["ui:widget"])==="file"&&((e=r===null||r===void 0?void 0:r.defaultValues)===null||e===void 0?void 0:e[t])){a.push(t)}}if(Object.keys(a).length){const t=await this.retrieveDocsForDispute(l);const i=Object.assign({},r.defaultValues);for(const s of a){const o=r.defaultValues[s];if(typeof o==="string"&&t[o]){i[s]=[t[o]]}else{i[s]=[]}}r.defaultValues=i;r.answeredDocsQns=a}return r};this.retrieveDocsForDispute=async(t,i=true)=>{var s;try{const i=r.get(d);const o=await i.execute(t);const n={};(((s=o===null||o===void 0?void 0:o.data)===null||s===void 0?void 0:s.documents)||[]).forEach((t=>{const i=new File([""],t.name,{type:t.type});i.documentId=t.id;n[t.id]=i}));return n}catch(t){this.handleDisputesErrors(t,i?C:S);return{}}};this.deleteDocForDispute=async(t,i)=>{try{const s=r.get(u);await s.execute(t,i);return false}catch(t){this.handleDisputesErrors(t,S);return true}};this.uploadFile=async t=>{var i,s;this.formRef.setErrors({});const o=this.questionnaireData.disputeId;const n=r.get(v);try{t.loading=true;const e=await n.execute(o,t,t.type,t.name);t.loading=false;const r=(s=(i=e===null||e===void 0?void 0:e.data)===null||i===void 0?void 0:i.document)===null||s===void 0?void 0:s.id;t.documentId=r;return r}catch(i){t.loading=false;t.error=O;return null}};this.handleFiles=async t=>{const i=[];let s=false;this.startLoadingAndClearError(q.fileUpload);for(let o of t){if(o.documentId){i.push(o.documentId);continue}const t=await this.uploadFile(o);if(!t){s=true}else i.push(t)}this.hideLoader();return{docIds:i,hasError:s}};this.getFieldValueToSubmit=async t=>{let i=false;let s=t;if(t===null||t===undefined||t.length===0)s=undefined;else if(typeof t==="number")s=t.toString();else if((t===null||t===void 0?void 0:t[0])instanceof File){const{docIds:o,hasError:n}=await this.handleFiles(t);i=n;s=o}return{newValue:s,hasError:i}};this.onFormSubmit=async t=>{var i,s;this.loadingButton=k.next;const o={};let n=false;for(const i in t.detail){let s=t.detail[i];const{newValue:e,hasError:r}=await this.getFieldValueToSubmit(s);if(!e)continue;if(r){n=r;this.formRef.setErrors({[i]:[]})}o[i]=e}if((s=(i=this.questionnaireData)===null||i===void 0?void 0:i.answeredDocsQns)===null||s===void 0?void 0:s.length){for(const t of this.questionnaireData.answeredDocsQns){if(!o[t])o[t]=[];const i=await this.handleFileDiff(t,o[t]);if(i)n=true}}if(!n)this.checkThenProceedToSubmitAnswer(o)};this.handleFileDiff=async(t,i)=>{var s;if(!Array.isArray((s=this.questionnaireData.defaultValues)===null||s===void 0?void 0:s[t])||!Array.isArray(i))return;const o=this.questionnaireData.defaultValues[t].map((t=>t.documentId));const n=o.filter((t=>!i.includes(t)));let e=false;if(n.length){this.startLoadingAndClearError(q.form);for(let t of n){const i=await this.deleteDocForDispute(this.questionnaireData.disputeId,t);if(i)e=true}this.hideLoader()}return e};this.checkThenProceedToSubmitAnswer=t=>{var i,s;const o=this.questionnaireData.stepId;const n={};let e=false;for(const t in this.questionnaireData.defaultValues){const o=this.questionnaireData.defaultValues[t];n[t]=(o===null||o===void 0?void 0:o[0])instanceof File?o.map((t=>t.documentId)):o;if(((i=this.questionnaireData.answeredDocsQns)===null||i===void 0?void 0:i.includes(t))&&!((s=n[t])===null||s===void 0?void 0:s.length)){e=true}}const r=this.stepsAnswered.has(Number(o))&&j(t,n);if(!r||e){const i={answers:[]};for(const s in t){i.answers.push({question_id:s,values:Array.isArray(t[s])?t[s]:[t[s]]})}if(i.answers.length===0){i.skip=true;delete i.answers}return this.answerQuestionnaire(i)}this.getStepData(this.questionnaireData.disputeId,Number(o)+1)};this.nextClick=()=>{if(!this.formRef){this.formRef=this.el.shadowRoot.querySelector("mq-dynamic-form")}this.formRef.submitForm()};this.goBackFromReview=()=>{this.loadingButton=k.back;let t=0;this.reviewData.steps.forEach((i=>{if(i.stepId>t)t=i.stepId}));if(t){this.getStepData(this.questionnaireData.disputeId,t)}};this.prevClick=()=>{this.loadingButton=k.back;const t=this.questionnaireData.stepId;if(t>1)this.getStepData(this.questionnaireData.disputeId,t-1)};this.submitClick=async()=>{var t,i,s,o,n;if(this.error.message){this.getReviewData(this.questionnaireData.disputeId);return}this.loadingButton=k.submit;this.startLoadingAndClearError(q.confirmation);this.mqFileDisputeActionTriggered.emit({type:T.DISPUTE_SUBMISSION,data:{transactionToken:this.transactionToken}});try{const s=r.get(f);const o=await s.execute(this.questionnaireData.disputeId,{submit:true});if(o.data){this.success={message:(t=o.data.message)!==null&&t!==void 0?t:"",description:(i=o.data.description)!==null&&i!==void 0?i:""}}if(this.showSuccessAndFailureStates){this.viewType=x.success}setTimeout((()=>{this.mqFileDisputeActionCompleted.emit({type:T.DISPUTE_SUBMISSION,status:g.SUCCESS,data:{transactionToken:this.transactionToken}})}),0)}catch(t){this.handleDisputesErrors(t,S);const i=(s=t===null||t===void 0?void 0:t.originalError)===null||s===void 0?void 0:s.message;const e=(n=(o=t===null||t===void 0?void 0:t.originalError)===null||o===void 0?void 0:o.debug)===null||n===void 0?void 0:n[0];setTimeout((()=>{var t,s,o,n;this.mqFileDisputeActionCompleted.emit({type:T.DISPUTE_SUBMISSION,status:g.ERROR,data:{transactionToken:this.transactionToken},error:{code:i||"DISPUTE_SUBMISSION_ERROR",message:(n=(s=(t=e===null||e===void 0?void 0:e.data)===null||t===void 0?void 0:t.error_message)!==null&&s!==void 0?s:(o=e===null||e===void 0?void 0:e.data)===null||o===void 0?void 0:o.description)!==null&&n!==void 0?n:S}})}),0)}this.hideLoader()};this.onValidation=t=>{const i=t.detail;if(Object.keys(i).length){this.allowSubmit=false}else{this.allowSubmit=true}};this.renderStepButtons=()=>{if(!this.questionnaireData.schema)return null;const t=this.questionnaireData.stepId>1;const i=this.showLoaderType!==q.none;const o=i&&this.loadingButton===k.next;const n=i&&this.loadingButton===k.back;return s("mq-button-group",{primaryButton:{label:"Next",onClick:this.nextClick,disabled:!this.allowSubmit||n,loading:o,fixed:false},secondaryButton:{label:"Back",onClick:this.prevClick,disabled:o,loading:n,fixed:false},showSecondaryButton:t})};this.renderReviewButtons=()=>{if(this.showLoaderType===q.confirmation)return null;const t=this.showLoaderType!==q.none;const i=t&&this.loadingButton===k.submit;const o=t&&this.loadingButton===k.back;return s("mq-button-group",{primaryButton:{label:"Submit",onClick:this.submitClick,loading:i,disabled:o,fixed:false},secondaryButton:{label:"Back",onClick:this.goBackFromReview,loading:o,disabled:i,fixed:false},showSecondaryButton:true})};this.renderForm=()=>{const t=this.showLoaderType!==q.none&&this.showLoaderType!==q.fileUpload;return s(o,null,s("mq-dynamic-form",{class:t?"hidden":`${this.questionnaireData.stepId}`,key:`${this.questionnaireData.stepId}-${this.questionnaireData.completedTime}`,schema:this.questionnaireData.schema||{properties:{}},uiSchema:Object.assign(Object.assign({},this.questionnaireData.uiSchema||{}),{"ui:rootFieldId":"fileDisputeForm","ui:globalOptions":{rowGap:{xs:32,sm:32,md:32,lg:32,xl:32}}}),initialValues:this.questionnaireData.defaultValues,onDynamicFormSubmitTriggered:this.onFormSubmit,onDynamicFormValidationTriggered:this.onValidation,ref:t=>this.formRef=t}),this.renderStepButtons())};this.renderReview=()=>{if(!this.reviewData.answersForReview.length)return null;const t=this.showLoaderType!==q.none;return s(o,null,!t&&s("flex-container",{class:"review-container","aria-label":"Review container"},this.reviewData.answersForReview.map((t=>{const i=t.answers.join(",");return i?s("div",null,s("mq-text",{type:"label",colorType:"primary"},t.question),s("mq-vspacer",{factor:2}),s("mq-text",{colorType:"secondary"},i)):null}))),this.renderReviewButtons())};this.renderBodySkeleton=()=>{if(this.showLoaderType===q.none)return null;return s("mq-file-dispute-skeleton-loader",{type:this.showLoaderType})};this.handleDoneClick=t=>()=>{this.mqFileDisputeActionHook.emit({type:t,data:{transactionToken:this.transactionToken}})};this.renderSuccess=()=>{const t=this.size==="xs";return s("mq-end-card",{icon:"checkmark-final",showAnimation:true,titleText:this.success.message,subtitleText:this.success.description,buttonSize:t?b.large:b.small,onMqEndCardButtonClicked:this.handleDoneClick(w.SUCCESS_DONE),showUniversalPadding:false})};this.renderError=()=>{const t=this.size==="xs";return s("mq-end-card",{icon:"circle-error",titleText:this.error.message,subtitleText:this.error.description,buttonSize:t?b.large:b.large,onMqEndCardButtonClicked:this.handleDoneClick(w.ERROR_DONE),showUniversalPadding:false})};this.transactionToken=undefined;this.showTitle=true;this.showSuccessAndFailureStates=true;this.questionnaireData={};this.viewType=x.questionnaire;this.reviewData={steps:[],answersForReview:[],documentQuestions:[]};this.error={message:"",description:""};this.success={message:"",description:""};this.size="md";this.allowSubmit=false;this.showLoaderType=q.none;this.stepsAnswered=new Set;this.loadingButton=k.none}async connectedCallback(){this.mqFileDisputeLoadInitiated.emit();m((t=>{t&&this.loadFileDisputeForm()}))}componentDidLoad(){const t=y(this.el);this.size=t}render(){if(!p.mqCuiReady)return null;const t=this.viewType===x.success||this.viewType===x.error;const i=!t&&this.showLoaderType!==q.confirmation;const e=this.questionnaireData.infoLabel&&this.showLoaderType===q.none&&this.viewType===x.questionnaire;const r=this.error.message||e;return s(n,null,s("theme-provider",null,s("div",{class:`file-dispute-form ${t?"end":""}`},i&&s(o,null,this.showTitle&&s(o,null,s("mq-text",{type:"heading","aria-label":"Report a problem"},"Report a problem"),s("mq-vspacer",{factor:r?4:6})),e&&s(o,null,s("mq-alert",{type:"info"},this.questionnaireData.infoLabel),s("mq-vspacer",{factor:6})),this.error.message&&s(o,null,s("mq-alert",{heading:this.error.message,type:"error"},this.error.description),s("mq-vspacer",{factor:6}))),this.renderBodySkeleton(),this.viewType===x.questionnaire&&this.renderForm(),this.viewType===x.review&&this.renderReview(),this.viewType===x.success&&this.renderSuccess(),this.viewType===x.error&&this.renderError())))}get el(){return e(this)}};D.style=A;export{D as mq_file_dispute};
//# sourceMappingURL=p-df8306fb.entry.js.map