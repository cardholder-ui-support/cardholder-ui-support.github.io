<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUI Dogfood Production</title>

    <script type="module" src="https://web.cardholder-ui-sdk.marqeta.com/_/releases/0.10/index.js"></script>
    <script>
        // Function to extract URL parameters
        function getUrlParameter(name) {
            const regex = new RegExp(`[?&]${name}=([^&#]*)`);
            const results = regex.exec(window.location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        window.addEventListener("load", async () => {
            const applicationToken = getUrlParameter('applicationToken');
            const accessToken = getUrlParameter('accessToken');
            const userToken = getUrlParameter('userToken');
            const cardToken = getUrlParameter('cardToken'); // Extract cardToken
            const transactionToken = getUrlParameter('transactionToken'); // Extract transactionToken

            if (!applicationToken || !accessToken || !userToken) {
                console.error('Missing required URL parameters.');
                return;
            }

            // Base64 encode the credentials
            const credentials = `${applicationToken}:${accessToken}`;
            const base64Credentials = btoa(credentials);

            // Perform login
            let cuiAuthToken;
            try {
                const response = await fetch('https://cui-service-main.prod.us-east-1.mq01-prod.marqeta.io/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${base64Credentials}`
                    },
                    body: JSON.stringify({ 'user_token': userToken })
                });

                if (!response.ok) {
                    throw new Error('Login failed');
                }

                const data = await response.json();
                cuiAuthToken = data.token;

            } catch (error) {
                console.error('Error during login:', error);
                return;
            }

            // Initialize the Marqeta SDK
            window.marqeta.bootstrap({
                cuiAuthToken: cuiAuthToken,
            });

            document.querySelector('mq-account')
                .addEventListener('mqAccountLoadSuccess', async () => {
                    const msg = 'Yay!! Your mq-account data has loaded successfully!';
                    const customLog = document.getElementById('custom_log');
                    customLog.innerHTML += `${msg}`;
                });

            // Replace card-token attributes with the cardToken from URL
            document.querySelectorAll('[card-token]').forEach(el => {
                el.setAttribute('card-token', cardToken);
            });

            document.querySelectorAll('[transaction-token]').forEach(el => {
                el.setAttribute('transaction-token', transactionToken);
            });
        });
    </script>

    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        .row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #ccc; /* Optional separation */
        }
        .component {
            flex: 1;
        }
        .title {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }
    </style>
</head>
<body>

<h1>CUI Dogfood Production</h1>

<div id="custom_log"></div>

<div class="container">
    <div class="row">
        <div class="component"><mq-account></mq-account></div>
        <div class="title">Account Management</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-activate-card
                class="accepts-card-token"
                show-title={true}
                show-description={true}
                card-token="{cardToken}"
            ></mq-activate-card>
        </div>
        <div class="title">Activate Card</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-reveal-pin
                class="accepts-card-token"
                show-title={true}
                card-token="{cardToken}"
                cardholder-verification-method="OTHER"
                timeout={10}
            ></mq-reveal-pin>
        </div>
        <div class="title">Reveal PIN</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-set-pin
                class="accepts-card-token"
                show-title={true}
                show-description={true}
                card-token="{cardToken}"
            ></mq-set-pin>
        </div>
        <div class="title">Set PIN</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-view-card-details
                class="accepts-card-token"
                card-token="{cardToken}"
            ></mq-view-card-details>
        </div>
        <div class="title">View Card Details</div>
    </div>

    <div class="row">
        <div class="component"><mq-transaction-activity></mq-transaction-activity></div>
        <div class="title">Transaction Activity</div>
    </div>

    <div class="row">
        <div class="component"><mq-manage-linked-accounts></mq-manage-linked-accounts></div>
        <div class="title">Manage Linked Accounts</div>
    </div>

    <div class="row">
        <div class="component"><mq-add-linked-account></mq-add-linked-account></div>
        <div class="title">Add Linked Account</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-add-funds class="accepts-card-token"></mq-add-funds>
        </div>
        <div class="title">Add Funds</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-kyc raw-disclosures='[{"title":"Example agreement","src":"https://example.com"}]'></mq-kyc>
        </div>
        <div class="title">KYC</div>
    </div>

    <div class="row">
        <div class="component">
            <mq-dispute-intake-form 
                transaction-token="{transactionToken}"
                show-title={true}
                show-success-and-failure-states={true}
            ></mq-dispute-intake-form>
        </div>
        <div class="title">Dispute Intake Form</div>
    </div>
</div>

</body>
</html>
